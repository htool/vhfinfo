<html>
<head>
  <META http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <META http-equiv="Pragma" content="no-cache" />
  <META http-equiv="Expires" content="0" />
  <META content="IE=11.0000" http-equiv="X-UA-Compatible">
  <META charset="utf-8">
  <META name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <META name="navico-store" content="mfd-insight-store">
  <title>VHFinfo</title>
  <script type='text/javascript' src='/jquery/dist/jquery.min.js'></script>
  <script>document.write('<link rel="stylesheet" href="style.css?ver=' + Math.floor(Math.random() * 1000) + '">');</script>
</head>
<body>

<script>

// Set day or night mode

var connected=false;
var ws;
var wsNr = 0;
var nearest = {}
var numeric = /[0-9]+/


function connect () {
  if (connected || wsNr >= 1) {
    return
  };
  ws = new WebSocket((window.location.protocol === 'https:' ? 'wss' : 'ws') + "://" + window.location.host + "/signalk/v1/stream?subscribe=none");
	ws.onopen = function() {
    wsNr++;
	  connected = true;

    var paths = [{ "path": "resources.vhfdata.*" }]
    var subscriptionObject = {
      "context": "vessels.self",
      "subscribe": paths
    }
    var subscriptionMessage = JSON.stringify(subscriptionObject);
    console.log("subscriptionMessage: " + subscriptionMessage);
    ws.send(subscriptionMessage);

    ws.onmessage = function(event) {
      if (event.data.includes('signalk-server')) {
        welcomeMessage = event.data;
        console.log("Skipping welcome message: " + welcomeMessage)
      } else {
        handleData(JSON.parse(event.data));
      }
    }

	  ws.onclose = function() {
	    connected = false;
      wsNr--;
	    console.log("WebSocket closed - wsNr: " + wsNr);
      if (instantReconnect) {
        instantReconnect = false;
        connect();
      } else {
        setInterval(function() {
          connect();
        }, 1000);
      }
	  }

	  ws.onerror = function(err) {
	    console.log("WebSocket connection error: " + err.message + " - closing connection");
      ws.close();
	  }
    
  }
}

connect();


function handleData (data) {
  var path = data.updates[0].values[0].path.replace('resources.vhfdata.nearest.', '')
  var value = data.updates[0].values[0].value
  nearest[path] = JSON.parse(value)
  if (path.match(numeric)) {
    console.log(path)
    updateNearest (path)
  }
}

function updateNearest (id) {
  console.log(nearest[id])
  var fields = ['name', 'callname', 'channel']
  var sub_types = ['generic', 'pleasure', 'cargo']
  var sub_fields = ['note', 'mode']
  
  fields.forEach(field => {
    if (typeof nearest[id][field] != 'undefined') {
      document.getElementById(field + "_" + id).innerHTML = nearest[id][field]
    } else {
      document.getElementById(field + "_" + id).innerHTML = ''
    }
  })
  var mode
  if (typeof nearest[id].vhfdata != 'undefined' && typeof nearest[id].vhfdata.generic != 'undefined' && typeof nearest[id].vhfdata.generic.mode != 'undefined') {
    mode = nearest[id].vhfdata.generic.mode
  }
  if (typeof nearest[id].vhfdata != 'undefined' && typeof nearest[id].vhfdata.pleasure != 'undefined' && typeof nearest[id].vhfdata.pleasure.mode != 'undefined') {
    mode = nearest[id].vhfdata.pleasure.mode
  }
  document.getElementById("type_" + id).innerHTML = mode.toUpperCase() + " &#8227; " + nearest[id].type.toUpperCase() + " &#8227; " + nearest[id].distance + "m"
  document.getElementById("url_" + id).innerHTML = '<a href="' + nearest[id].url + '" style="text-decoration:none; color: white">&#128279;</a>'
  document.getElementById("phone_" + id).innerHTML = '<a href="tel:' + nearest[id].phone + '" style="text-decoration:none; color: white">&#9990;</a>'
  sub_types.forEach(sub_type => {
	  sub_fields.forEach(field => {
	    if (typeof nearest[id].vhfdata != 'undefined' && typeof nearest[id].vhfdata[sub_type] != 'undefined' && typeof nearest[id].vhfdata[sub_type][field] != 'undefined') {
	      document.getElementById(sub_type + "_" + field + "_" + id).innerHTML = nearest[id].vhfdata[sub_type][field]
	    } else {
	      document.getElementById(sub_type + "_" + field + "_" + id).innerHTML = ''
	    }
	  })
  })

}

document.write('<div class="header"></div>')
for (x=0; x<= 20; x++) {
  document.write('<div class="entry">')
  document.write('<div class="channel" id="channel_' + x + '"></div>')
  document.write('<div class="nameblock"><div class="name" id="name_' + x + '"></div>')
  document.write('<div class="callname" id="callname_' + x + '"></div></div>')
  document.write('<div class="typeblock">')
  document.write('<div class="type" id="type_' + x + '"></div>')
  document.write('<div class="phone" id="phone_' + x + '"></div>')
  document.write('<div class="url" id="url_' + x + '"></div></div>')
  document.write('<div class="note" id="note_' + x + '"></div>')
  document.write('<div class="note" id="generic_note_' + x + '"></div>')
  document.write('<div class="note" id="pleasure_note_' + x + '"></div>')
  document.write('<div class="note" id="cargo_note_' + x + '"></div>')
  document.write('</div>')
}

</script>
</body>
</html>
